<!DOCTYPE html>
<html class="has-navbar-fixed-top" lang="pt-BR">
<head>
    {% include 'core/partials/head.html' %}
    <title>Cadastro de Consulta</title>
</head>
<body>
    {% include 'core/partials/header.html' %}
    <section class="hero is-primary is-fullheight">
        <div class="hero-body">
            <div class="container">
                {% if not paciente %}
                <!-- Aba de seleção do paciente -->
                <div class="columns">
                    <div class="column">
                        <div class="card" id="buscar-paciente-card">
                            <header class="card-header">
                                <p class="card-header-title is-centered">Nova Consulta</p>
                            </header>
                            <div class="card-content">
                                <div class="content">
                                    <form id="buscar-paciente-form" onsubmit="redirecionar(event)">
                                        {% csrf_token %}
                                        <div class="field">
                                            <label class="label">Nome do Paciente:</label>
                                            <div class="control">
                                                <select class="js-example-basic-single" id="id_paciente" name="id_paciente" style="width: 100%;">
                                                    <option value="" disabled selected>Selecione o paciente</option>
                                                    {% for paciente in pacientes %}
                                                        <option value="{{ paciente.id_paciente}}">{{ paciente.nome|title  }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="buttons is-right">
                                            <input class="button is-primary is-rounded" type="submit" value="Iniciar Consulta">
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if paciente %}

            <div class="columns">
                <div class="column">
                    <div class="card">
                        <header class="card-header">
                        <p class="card-header-title is-centered">Cadastro de Consulta</p>
                        </header>
                        <div class="card-content">
                            <div class="content">

                <!-- Formulário de nova consulta -->
                                <form id="nova-consulta-form" action="{% url 'novaConsulta' paciente.id_paciente %}" method="post" onsubmit="return mostrarAviso()">
                                    {% csrf_token %}
                                    <div class="field">
                                        <label class="label">Nome do Paciente:</label>
                                        <div class="control">
                                            <input class="input" type="text" value="{{ paciente.nome|title }}" readonly>
                                        </div>
                                    </div>

                                    <div class="field is-flex">
                                        <label class="label" style="margin-right: 0.5rem;">Idade:</label>
                                        <span id="idade"></span>
                                        <input type="hidden" id="idadeInput" name="idade">
                                        <input type="hidden" id="idadeMesesInput" name="idadeMeses">
                                    </div>

                                    <div class="field is-flex" id="idade-corrigida-container" style="display: none;">
                                        <label class="label" style="margin-right: 0.5rem;">Idade Corrigida: </label>
                                        <span id="idadeCorrigida"></span>
                                        <input type="hidden" name="idadeCorrigida" id="idadeCorrigida">
                                        <input type="hidden" id="semanasCorrigidas" value="{{ paciente.semanasCorrigidas }}">
                                        <input type="hidden" id="diasCorrigidos" value="{{ paciente.diasCorrigidos }}">
                                    </div>

                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Comorbidade:</label>
                                        <span class="resposta-historico">{{ consultaAnterior.especificacaoDoencaPrevia }}</span>
                                    </div>

                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Medicamentos:</label>
                                        <span class="resposta-historico">{{ consultaAnterior.especificacaoMedicamentoUso }}</span>
                                    </div>
                                    
                                    <p class="card-header-title is-centered">Histórico do Paciente</p>
                                    <br>

                                    <!--Inserir histórico do paciente como read-->
                                    {% if consultaAnterior %}


                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Data da Última Consulta:</label>
                                        <span class="resposta-historico">{{ consultaAnterior.dataConsulta }}</span>
                                    </div>
                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Histórico Gestacional:</label>
                                        <span class="resposta-historico">{{ consultaAnterior.historicoGestacional }}</span>
                                    </div>
                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Peso (kg):</label>
                                        <span class="resposta-historico">{{ consultaAnterior.peso }} kg</span>
                                    </div>
                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Estatura (cm):</label>
                                        <span class="resposta-historico">{{ consultaAnterior.estatura }} cm</span>
                                    </div>
                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">IMC:</label>
                                        <span class="resposta-historico">{{ consultaAnterior.imc }}</span>
                                    </div>
                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Avaliação:</label>
                                        <span class="resposta-historico">{{ consultaAnterior.avaliacao }}</span>
                                    </div>
                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Plano de Conduta: </label>
                                        <span class="resposta-historico">{{ consultaAnterior.planoConduta }}</span>
                                    </div>
                                    
                                    {% else %}

                                    <div class="field is-flex">
                                        <label class="label" style="font-weight: bold;">Histórico:</label>

                                        <span class="resposta-historico">Nenhuma consulta registrada</span>
                                    </div>
                                    
                                    {% endif %}

                                    <hr style="border: 1px solid #ccc; margin: 20px 0;">
                                    
                                    <div class="field is-flex">
                                        <p class="card-header-title is-centered">Nova Consulta</p>
                                    </div>

                                    <div class="columns">
                                        <div class="column is-one-third">
                                            <div class="field">
                                                <label class="label" for="dataConsulta">Data da Consulta:</label>
                                                <div class="control">
                                                    <input class="input" type="date" id="dataConsulta" name="dataConsulta">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr style="margin: 20px 0;">

                                    <br>
                                    <div class="columns is-centered">
                                        <div class="column is-two-fifths">
                                            <div class="field">
                                                <label class="label" for="doencaPrevia">Possui Doença Prévia:</label>
                                                <div class="control">
                                                    <label class="radio">
                                                        <input type="radio" name="doencaPrevia" value="sim" id="doencaPreviaSim">
                                                        Sim
                                                    </label>
                                                    <label class="radio">
                                                        <input type="radio" name="doencaPrevia" value="nao" id="doencaPreviaNao">
                                                        Não
                                                    </label>
                                                </div>
                                                <div class="field campo-textareao" id="campoDoencaPrevia" style="display: none;">
                                                    <div class="control">
                                                        <input class="input" type="text" name="especificacaoDoencaPrevia" placeholder="Especifique a doença prévia...">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    
                                        <div class="column is-two-fifths">
                                            <div class="field">
                                                <label class="label" for="medicamentoUso">Faz Uso de Medicamentos:</label>
                                                <div class="control">
                                                    <label class="radio">
                                                        <input type="radio" name="medicamentoUso" value="sim" id="medicamentoUsoSim">
                                                        Sim
                                                    </label>
                                                    <label class="radio">
                                                        <input type="radio" name="medicamentoUso" value="nao" id="medicamentoUsoNao">
                                                        Não
                                                    </label>
                                                </div>
                                                <div class="field campo-textareao" id="campoMedicamentoUso" style="display: none;">
                                                    <div class="control">
                                                        <input class="input" type="text" name="especificacaoMedicamentoUso" placeholder="Especifique o medicamento...">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr style="margin: 20px 0;">
                                    <div class="textarea-center">
                                        <p class="card-header-title is-centered is-size-4">SUBJETIVO</p>
                                    </div>
                                    <br>
                                    
                                    <div class="field">
                                        <label class="label" for="historicoGestacional" >Histórico Gestacional: </label>
                                            <div class="control">
                                                <textarea class="textarea" id="historicoGestacional" name="historicoGestacional" placeholder="Digite o histórico gestacional do paciente"></textarea>                                            </div>
                                    </div>

                                    <div class="field">
                                        <label class="label" for="anamnese">Anamnese: </label>
                                            <div class="control">
                                                <textarea class="textarea" id="anamnese" name="anamnese" placeholder="Digite a anamnese do paciente"></textarea>
                                            </div>    
                                    </div>
                                    <br>

                                    <hr style="margin: 20px 0;">
                                    <div class="textarea-center">
                                        <p class="card-header-title is-centered is-size-4">OBJETIVO</p>
                                    </div>
                                    <br>
                                    
                                    <div class="columns">
                                        <div class="column is-one-third">
                                            <div class="field">
                                                <label class="label" for="pesoInput">Peso(kg):</label>
                                                    <div class="control">
                                                        <input class="input" type="number" step="0.1" id="pesoInput" name="peso" placeholder="Digite o peso do paciente">
                                                    </div>
                                            </div>
                                        </div>
                                    
                                        <div class="column is-one-third">
                                            <div class="field">
                                                <label class="label" for="avaliacaoPeso">Avaliação Peso: </label>
                                                    <div class="control">
                                                        <input class="input" type="text" id="avaliacaoPeso" name="avaliacaoPeso" placeholder="Descreva sobre o peso do paciente">
                                                    </div>
                                            </div>
                                        </div>
                                    
                                        <div class="column">
                                            <div class="field">
                                                <label class="label">&nbsp;</label>
                                                    <div class="control">
                                                        <button class="button is-link" type="button" onclick="calcularIMC()">Calcular IMC</button>
                                                    </div>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="columns">
                                        <div class="column is-one-third">
                                            <div class="field">
                                                <label class="label" for="estaturaInput">Estatura(cm):</label>
                                                    <div class="control">
                                                        <input class="input" type="number" step="0.1" id="estaturaInput" name="estatura" placeholder="Digite a estatura do paciente">
                                                    </div>
                                            </div>
                                        </div>

                                        <div class="column is-one-third">
                                            <div class="field">
                                                <label class="label" for="avaliacaoEstatura">Avaliação Estatura: </label>
                                                    <div class="control">
                                                        <input class="input" type="text" id="avaliacaoEstatura" name="avaliacaoEstatura" placeholder="Descreva sobre a estatura do paciente" readonly>
                                                    </div>
                                            </div>
                                        </div>

                                        <div class="column">
                                            <div class="field">
                                                <label class="label">&nbsp;</label>
                                                    <div class="control">
                                                        <button class="button is-link" type="button" onclick="mostrarGraficoCrescimento()">Mostrar Gráfico do Crescimento</button>
                                                    </div>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="field">
                                        <label class="label" for="imcResult">IMC: </label>
                                            <div class="control">
                                                <input class="input" type="number" id="imcResult" name="imc" placeholder="IMC" readonly>
                                            </div>
                                    </div>

                                    <div class="table-container" id="imcTable" style="display: none;">
                                        <div class="card-content">
                                            <div class="columns">
                                                <div class="column">
                                                    <div class="field">
                                                        <label class="label">Classificação: </label>
                                                            <div class="control">
                                                                <span id="imcClassificacao"></span> <!-- Onde a classificação será exibida -->
                                                            </div>
                                                    </div>                                               
                                                </div>
                                                <div class="column">
                                                    <table class="table is-striped" style="max-width: 70%;">
                                                        <thead>
                                                            <tr>
                                                                <th>Classificação</th>
                                                                <th>IMC (kg/m²)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>Abaixo do peso</td>
                                                                <td>Menor que 18.5</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Peso normal</td>
                                                                <td>Entre 18.5 - 24.9</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Sobrepeso</td>
                                                                <td>Entre 25 - 29.9</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Obesidade grau I</td>
                                                                <td>Entre 30 - 34.9</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Obesidade grau II</td>
                                                                <td>Entre 35 - 39.9</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Obesidade grau III</td>
                                                                <td>Maior ou igual 40</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="columns">
                                        <div class="column">
                                            <div class="field">
                                                <label class="label" for="perimetroCefalico">Perímetro Cefálico: </label>
                                                    <div class="control">
                                                        <input class="input" type="number" step="0.1" id="perimetroCefalico" name="perimetroCefalico" placeholder="Digite o perímetro cefálico do paciente">
                                                    </div>
                                            </div>
                                        </div> 
                                        
                                        <div class="column">
                                            <div class="field">
                                                <label class="label" for="testeReflexoVermelho">Teste do Reflexo Vermelho: </label>
                                                    <div class="control">
                                                        <input class="input" type="text" id="testeReflexoVermelho" name="testeReflexoVermelho" placeholder="Descreva o exame de teste reflexo vermelho do paciente">
                                                    </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field">
                                        <label class="label" for="auscultaCardiaca">Ausculta Cardíaca: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="auscultaCardiaca" name="auscultaCardiaca" placeholder="Descreva a ausculta cardíaca do paciente">
                                            </div>  
                                    </div>

                                    <div class="columns">
                                        <div class="column">
                                            <div class="field">
                                                <label class="label" for="frequenciaCardiaca">Frequência Cardíaca: </label>
                                                    <div class="control">
                                                        <input class="input" type="text" id="frequenciaCardiaca" name="frequenciaCardiaca" placeholder="Digite a frequência cardíaca do paciente">
                                                    </div>  
                                            </div>
                                        </div>   
                                        
                                        <div class="column">
                                            <div class="field">
                                                <label class="label" for="pressaoArterial">Pressão Arterial: </label>
                                                    <div class="control">
                                                        <input class="input" type="number" step="0.1" id="pressaoArterial" name="pressaoArterial" placeholder="Digite a pressão arterial do paciente">
                                                    </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field">
                                        <label class="label" for="auscultaPulmonar">Ausculta Pulmonar: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="auscultaPulmonar" name="auscultaPulmonar" placeholder="Descreva a ausculta pulmonar do paciente">
                                            </div>  
                                    </div>

                                    <div class="columns">
                                        <div class="column is-half">
                                            <div class="field">
                                                <label class="label" for="frequenciaRespiratoria">Frequência Respiratória: </label>
                                                    <div class="control">
                                                        <input class="input" type="number" step="0.1" id="frequenciaRespiratoria" name="frequenciaRespiratoria" placeholder="Digite a frequência repisratória paciente">
                                                    </div>
                                            </div>
                                        </div>
                                    
                                        <div class="column">
                                            <div class="field">
                                                <label class="label" for="temperatura">Temperatura: </label>
                                                    <div class="control">
                                                        <input class="input" type="text" id="temperatura" name="temperatura" placeholder="Insira a temperatura do paciente">
                                                    </div> 
                                            </div> 
                                        </div>
                                    </div>

                                    <div class="field">
                                        <label class="label" for="oroscopia">Oroscopia: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="oroscopia" name="oroscopia" placeholder="Descreva o exame de OROSCOPIA do paciente">
                                            </div>  
                                    </div>

                                    <div class="field">
                                        <label class="label" for="otoscopia">Otoscopia: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="otoscopia" name="otoscopia" placeholder="Descreva o exame de OTOSCOPIA do paciente">
                                            </div>  
                                    </div>

                                    <div class="field">
                                        <label class="label" for="exameAbdominal">Exame Abdominal: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="exameAbdominal" name="exameAbdominal" placeholder="Descreva o exame abdominal do paciente">
                                            </div>  
                                    </div>

                                    <div class="field">
                                        <label class="label" for="genituPelve">Geniturinário e Pelve: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="genituPelve" name="genituPelve" placeholder="Descreva o exame geniturinário e pelve do paciente">
                                            </div>  
                                    </div>

                                    <div class="field">
                                        <label class="label" for="tanner">Avaliação de Tanner: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="tanner" name="tanner" placeholder="Descreva a avaliação de tanner do paciente">
                                            </div>  
                                    </div>

                                    <div class="field">
                                        <label class="label" for="membrosInferiores">Exame de Membros Inferiores: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="membrosInferiores" name="membrosInferiores" placeholder="Descreva o exame de membros inferiores do paciente">
                                            </div>  
                                    </div>

                                    <div class="field">
                                        <label class="label" for="pele">Exame de Pele e Anexos: </label>
                                            <div class="control">
                                                <input class="input" type="text" id="pele" name="pele" placeholder="Descreva o exame de pele e anexos do paciente">
                                            </div>  
                                    </div>

                                    <div class="field">
                                        <label class="label" for="outrosExames">Outros Exames Realizados: </label>
                                            <div class="control">
                                                <textarea class="textarea" id="outrosExames" name="outrosExames" placeholder="Descreva os outros exames ralizados no paciente"></textarea>
                                            </div>  
                                    </div>
                                    <br>

                                    <hr style="margin: 20px 0;">
                                    <div class="textarea-center">
                                        <p class="card-header-title is-centered is-size-4">AVALIAÇÃO</p>
                                    </div>
                                    <br>

                                    <div class="field">
                                        <label class="label" for="avaliacao">Avaliação:</label>
                                            <div class="control">
                                               <textarea class="textarea" id="avaliacao" name="avaliacao" placeholder="Descreva a avaliação do paciente"></textarea>
                                            </div>
                                    </div>

                                    <div class="field">
                                        <label class="label" for="cid">CID:</label>
                                            <div class="control">
                                                <input class="input" type="text" id="cid" name="cid" placeholder="Digite o CID do paciente"></input>
                                            </div>
                                    </div>
                                    <br>

                                    <hr style="margin: 20px 0;">
                                    <div class="textarea-center">
                                        <p class="card-header-title is-centered is-size-4">PLANO DE CONDUTA</p>
                                    </div>
                                    <br>

                                    <div class="field">
                                        <label class="label" for="planoConduta">Plano de Conduta:</label>
                                            <div class="control">
                                                <textarea class="textarea" id="planoConduta" name="planoConduta" placeholder="Descreva o plano de conduta do paciente"></textarea>
                                            </div>
                                    </div>

                                    <br>
                                    <div class="field is-grouped" style="justify-content: flex-end; gap: 0.5rem;">
                                        <button class="button is-success"  type="submit">
                                            <span class="icon is-small">
                                            <i class="fas fa-check"></i>
                                            </span>
                                            <span>Salvar</span>
                                        </button>

                                        <button class="button is-danger is-outlined"  type="button" onclick="window.location.href='{% url 'nova_consulta_listar_pacientes' %}';">
                                            <span>Cancelar</span>
                                            <span class="icon is-small">
                                            <i class="fas fa-times"></i>
                                            </span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

</section>
    
<!-- jQuery (necessário para o Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>

function mostrarGraficoCrescimento() {
    const idadeMeses = document.getElementById('idadeMesesInput').value;
    const estatura = document.getElementById('estaturaInput').value;
    const pacienteId = "{{ paciente.id_paciente }}";

    if (!idadeMeses || !estatura) {
        alert('Preencha a estatura e a idade para visualizar o gráfico.');
        return;
    }

    // Monta a URL para o gráfico, passando os dados como parâmetros
    const url = `/grafico-crescimento/${pacienteId}/?idade_meses=${idadeMeses}&estatura=${estatura}`;
    window.open(url, '_blank');
}

function calcularIMC() {
    // Obtém os valores de peso e estatura
    const peso = parseFloat(document.getElementById('pesoInput').value);
    const estatura = parseFloat(document.getElementById('estaturaInput').value) / 100; // Converte cm para metros

    // Verifica se os valores são válidos
    if (!isNaN(peso) && !isNaN(estatura) && estatura > 0) {
        // Calcula o IMC
        const imc = (peso / (estatura * estatura)).toFixed(2);
        document.getElementById('imcResult').value = imc;

        // Determina a classificação do IMC
        let classificacao;
        if (imc < 18.5) {
            classificacao = "Abaixo do peso - Menor que 18.5";
        } else if (imc >= 18.5 && imc <= 24.9) {
            classificacao = "Peso normal - Entre 18.5 e 24.9";
        } else if (imc >= 25 && imc <= 29.9) {
            classificacao = "Sobrepeso - Entre 25 e 29.9";
        } else if (imc >= 30 && imc <= 34.9) {
            classificacao = "Obesidade grau I - Entre 30 e 34.9";
        } else if (imc >= 35 && imc <= 39.9) {
            classificacao = "Obesidade grau II - Entre 35 e 39.9";
        } else {
            classificacao = "Obesidade grau III - Maior ou igual a 40";
        }

        // Exibe a classificação e a tabela de IMC
        document.getElementById('imcClassificacao').textContent = classificacao;
        document.getElementById('imcTable').style.display = 'block';
    } else {
        // Exibe um alerta se os valores forem inválidos
        alert('Por favor, preencha os campos de peso e estatura corretamente.');
    }
}

function redirecionar(event) {
    event.preventDefault(); // Impede o envio padrão do formulário
    const select = document.getElementById('id_paciente');
    const idPaciente = select.value; // Obtém o ID do paciente selecionado
    if (idPaciente) {
        window.location.href = `/novaConsulta/${idPaciente}/`;
    } else {
        alert('Por favor, selecione um paciente.');
    }
}

function inicializarNovaConsultaScripts() {
    // Impede submit com Enter exceto em textarea
    const form = document.getElementById('nova-consulta-form');
    if (form) {
        form.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement.tagName.toLowerCase() === 'textarea') {
                    return;
                }
                event.preventDefault();
                const formElements = Array.from(form.elements);
                const currentIndex = formElements.indexOf(activeElement);
                const nextElement = formElements[currentIndex + 1];
                if (nextElement) {
                    nextElement.focus();
                }
            }
        });
    }

    // Select2
    if (window.jQuery && $('.js-example-basic-single').length) {
        $('.js-example-basic-single').select2({
            placeholder: "Selecione o paciente",
            allowClear: true
        });
    }

    // Mostrar/ocultar campos de doenças prévias e medicamentos
    const doencaPrevias = document.querySelectorAll('input[name="doencaPrevia"]');
    const medicamentoUso = document.querySelectorAll('input[name="medicamentoUso"]');
    doencaPrevias.forEach(input => {
        input.addEventListener('change', function () {
            const campoDoencaPrevias = document.getElementById('campoDoencaPrevia');
            campoDoencaPrevias.style.display = this.value === 'sim' ? 'block' : 'none';
        });
    });
    medicamentoUso.forEach(input => {
        input.addEventListener('change', function () {
            const campoMedicamentoUso = document.getElementById('campoMedicamentoUso');
            campoMedicamentoUso.style.display = this.value === 'sim' ? 'block' : 'none';
        });
    });

    // Preencher data da consulta com data atual
    const dataConsultaInput = document.querySelector('input[name="dataConsulta"]');
    if (dataConsultaInput) {
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const ano = hoje.getFullYear();
        const dataAtual = `${ano}-${mes}-${dia}`;
        dataConsultaInput.value = dataAtual;
    }
}


document.addEventListener('DOMContentLoaded', function () {
    const dataNascimento = "{{ paciente.data_nascimento|date:'Y-m-d' }}";
    const idadeSpan = document.getElementById('idade');
    const idadeInput = document.getElementById('idadeInput');
    const idadeMesInput = document.getElementById('idadeMesesInput');
    const idadeCorrigidaInput = document.getElementById('idadeCorrigida');
    const idadeCorrigidaContainer = document.getElementById('idade-corrigida-container');

    const semanasNascimento = parseInt(document.getElementById('semanasCorrigidas').value);
    const diasNascimento = parseInt(document.getElementById('diasCorrigidos').value);

    if (dataNascimento) {
        const hoje = new Date();
        const nascimento = new Date(dataNascimento);

        let anos = hoje.getFullYear() - nascimento.getFullYear();
        let meses = hoje.getMonth() - nascimento.getMonth();
        let dias = hoje.getDate() - nascimento.getDate();

        if (meses < 0 || (meses === 0 && dias < 0)) {
            anos--;
            meses += 12;
        }

        if (dias < 0) {
            const ultimoDiaMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0).getDate();
            dias += ultimoDiaMesAnterior;
            meses--;
        }

        const idadeCompleta = `${anos} anos ${meses} meses ${dias} dias`;
        idadeSpan.textContent = idadeCompleta;
        idadeInput.value = idadeCompleta;
        idadeMesInput.value = anos * 12 + meses;

        // ===== Cálculo da Idade Corrigida =====
        const prematuro = semanasNascimento < 40 || diasNascimento > 0;

        if (prematuro && !isNaN(semanasNascimento)) {
            const semanasPrematuras = 40 - semanasNascimento;
            const diasPrematurosTotais = (semanasPrematuras * 7) + (diasNascimento || 0);

            const idadeCronologicaDias = Math.floor((hoje - nascimento) / (1000 * 60 * 60 * 24));
            const idadeCorrigidaDias = idadeCronologicaDias - diasPrematurosTotais;

            const semanasCorrigidas = Math.max(0, Math.floor(idadeCorrigidaDias / 7));
            const diasCorrigidos = Math.max(0, idadeCorrigidaDias % 7);

            const mesesCorrigidos = Math.floor(idadeCorrigidaDias / 30.44); // média de dias por mês
            const diasRestantes = Math.round(idadeCorrigidaDias - (mesesCorrigidos * 30.44));


            const idadeCorrigidaTexto = `${semanasCorrigidas} semana${semanasCorrigidas !== 1 ? 's' : ''} e ${diasCorrigidos} dia${diasCorrigidos !== 1 ? 's' : ''}`;

            idadeCorrigidaInput.innerHTML = idadeCorrigidaTexto;
            idadeCorrigidaInput.value = idadeCorrigidaTexto;

            idadeCorrigidaContainer.style.display = "flex";
        } else {
            idadeCorrigidaContainer.style.display = "none";
        }

    } else {
        idadeSpan.textContent = "Data de nascimento não disponível";
        idadeInput.value = "";
        idadeMesInput.value = "";
        idadeCorrigidaContainer.style.display = "none";
    }
});


// Inicialização centralizada para cadastro de paciente e nova consulta
document.addEventListener('DOMContentLoaded', function () {
    inicializarNovaConsultaScripts();
});

        </script>
</body>
</html>
